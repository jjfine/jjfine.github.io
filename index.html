<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Portfolio Manager</title>
    <link rel="stylesheet" href="base.css" />
  </head>
  <body>
    <script src="lib/react-with-addons.js"></script>
    <script src="lib/JSXTransformer.js"></script>
    <script type="text/jsx">
      /** @jsx React.DOM **/
      var AddAssetForm = React.createClass({
        getInitialState: function() {
          return { symbol: '', shares: ''};
        },

        onChange: function() {
          this.setState(
              { symbol: this.refs.symbol.getDOMNode().value
              , shares: this.refs.shares.getDOMNode().value
          });
        },

        handleSubmit: function(e) {
          e.preventDefault();
          this.props.addAsset(this.state.symbol,this.state.shares);
        },
        
        render: function() {
          return (
            <form onSubmit={this.handleSubmit}>
              <input type="text" onChange={this.onChange} placeholder="Sybmol" ref="symbol" />
              <input type="text" onChange={this.onChange} placeholder="Shares" ref="shares" />
              <button>Add</button>
            </form>
          );
        }
      });

      var SharesInput = React.createClass({
        getInitialState: function() {
          this.refs.shares = this.props.initialShares;
          return { shares: this.props.initialShares};
        },

        onChange: function() {
          newShares = this.refs.shares.getDOMNode().value;
          this.setState({ shares: newShares });
          this.props.changeShares(newShares);
        },

        render: function() {
          return (
          <input type="text" onChange={this.onChange} placeholder="Shares" ref="shares" value={this.state.shares} />
          );
        }
      });

      var AssetRow = React.createClass({
        changeShares:function(shares) {
          this.props.changeAssetShares(this.props.asset.symbol, shares);
        },

        render: function() {
          return (
            <tr>
              <td>{this.props.asset.symbol}</td>
              <td><SharesInput changeShares={this.changeShares} initialShares={this.props.asset.shares} /></td>
              <td>{formatDollars(ASSET_PRICES[this.props.asset.symbol])}</td>
              <td>{formatDollars(ASSET_PRICES[this.props.asset.symbol]*this.props.asset.shares)}</td>
            </tr>
          );
        }
      });

      var AssetList = React.createClass({
        render: function() {
          var rows = [];
          this.props.assets.forEach(function(asset) {
            rows.push(<AssetRow asset={asset} key={asset.symbol} changeAssetShares={this.props.changeAssetShares} />);
          }.bind(this));
          return (
            <table>
              {rows}
            </table>
          );
        }
      });

      var PortfolioManager = React.createClass({
        getInitialState: function() {
          return { assets: SAMPLE_ASSETS };
        },

        addAsset: function(symbol, shares) {
          var newAssets = this.state.assets.concat({symbol: symbol, shares: shares});
          this.setState({assets: newAssets});
        },

        changeAssetShares: function(symbol, shares) {
          this.state.assets.forEach(function(el) { if (el["symbol"] === symbol) el["shares"] = shares; })
          this.setState({assets: this.state.assets});
        },

        render: function() {
          return (
            <div>
              <AddAssetForm addAsset={this.addAsset} />
              <AssetList assets={this.state.assets} changeAssetShares={this.changeAssetShares} />
            </div>
          );
        }
      });

      var formatDollars = function(x) { return "$" + x.toFixed(2); }

      var SAMPLE_ASSETS = [{symbol: "SCHA", shares: 50}, {symbol: "SCHX", shares: 10}, {symbol: "SCHF", shares: 5}];

      var ASSET_CLASSES = { "SCHA": ["small","domestic"]
                         , "SCHX": ["large","domestic"]
                         , "SCHF": ["large","foreign"]
                         , "SCHO": ["bond","domestic"]
                         };

      var ASSET_PRICES = { "SCHA": 51.76
                        , "SCHX": 44.83
                        , "SCHF": 31.90
                        , "SCHO": 50.56
                        };

      React.renderComponent(<PortfolioManager/>, document.body);

    </script>
  </body>
</html>
